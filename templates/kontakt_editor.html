<!DOCTYPE html>
{% extends 'base.html' %}
{% block title %}{% if kontakt %}Kontakt bearbeiten{% else %}Neuer Kontakt{% endif %}{% endblock %}

{% block content %}
<div id="kontakt-editor-app">
    <h1><span v-text="vorlage.name"></span>: {% if kontakt %}Kontakt bearbeiten{% else %}Neuen Kontakt anlegen{% endif
        %}</h1>

    <div class="card config-section active">
        <form action="{{ action_url }}" method="post">
            <div v-for="gruppe in vorlage.gruppen" :key="gruppe.id">
                <fieldset>
                    <legend v-text="gruppe.name"></legend>
                    <div v-for="eigenschaft in gruppe.eigenschaften" :key="eigenschaft.id" class="form-group">
                        <label :for="eigenschaft.name" v-text="eigenschaft.name"></label>

                        <select v-if="eigenschaft.datentyp === 'Verknüpfung'" :name="eigenschaft.name"
                            v-model="formData[eigenschaft.name]">
                            <option value="">-- Bitte wählen --</option>
                            <option v-for="k in verknuepfungsOptionen[eigenschaft.id]" :value="k.id"
                                v-text="k.display_name"></option>
                        </select>

                        <select v-else-if="eigenschaft.datentyp === 'Auswahl'" :name="eigenschaft.name"
                            v-model="formData[eigenschaft.name]">
                            <option value="">-- Bitte wählen --</option>
                            <option v-for="option in eigenschaft.optionen.split(',')" :value="option.trim()"
                                v-text="option.trim()"></option>
                        </select>

                        <input v-else-if="eigenschaft.datentyp === 'Boolean'" type="checkbox" :name="eigenschaft.name"
                            value="true" v-model="formData[eigenschaft.name]" style="width: auto; margin-top: 0.5rem;">

                        <input v-else :type="eigenschaft.datentyp.toLowerCase()" :name="eigenschaft.name"
                            v-model="formData[eigenschaft.name]">
                    </div>
                </fieldset>
            </div>

            <div class="button-group">
                <a href="{{ url_for('kontakte_auflisten') }}" class="button secondary">Abbrechen</a>
                <button type="submit">Speichern</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
    const { createApp, ref, onMounted } = Vue
    createApp({
        setup() {
            // Lade die JSON-Daten, die von Flask/Jinja2 bereitgestellt werden
            const vorlage = JSON.parse('{{ vorlage_for_json|tojson|safe }}');
            const kontaktDaten = JSON.parse('{{ kontakt_daten_for_json|tojson|safe }}');

            // Initialisiere die Formulardaten mit den bestehenden Werten des Kontakts
            const formData = ref({ ...kontaktDaten });

            const verknuepfungsOptionen = ref({});

            onMounted(async () => {
                // Lade die Optionen für alle Verknüpfungs-Felder
                for (const gruppe of vorlage.gruppen) {
                    for (const eigenschaft of gruppe.eigenschaften) {
                        if (eigenschaft.datentyp === 'Verknüpfung' && eigenschaft.optionen.startsWith('vorlage_id:')) {
                            const vorlageId = eigenschaft.optionen.split(':')[1];
                            try {
                                const response = await fetch(`/api/kontakte-by-vorlage/${vorlageId}`);
                                verknuepfungsOptionen.value[eigenschaft.id] = await response.json();
                            } catch (error) { console.error(error); }
                        }
                    }
                }
            });

            return { vorlage, formData, verknuepfungsOptionen };
        },
    }).mount('#kontakt-editor-app');
</script>
{% endblock %}
<!DOCTYPE html>
{% extends "base.html" %}
{% block title %}{{ 'Kontakt bearbeiten' if kontakt else 'Neuer Kontakt' }}{% endblock %}

{% block head_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/kontakte.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="actions-header">
        <h1>{{ 'Kontakt bearbeiten' if kontakt else 'Neuer Kontakt' }}</h1>
    </div>

    <form id="kontaktForm" method="POST" action="{{ action_url }}">
        <div class="form-container">
            <h2>Kontaktdaten (Vorlage: {{ vorlage_for_template.name }})</h2>

            <div id="kontakt_attributes" class="kontakt-attributes">
                {% for key, value in kontakt_daten_for_template.items() %}
                {% if key != 'Verknüpfungen' %}
                <div class="attribute-field">
                    <label>{{ key }}</label>
                    <div class="input-group">
                        <input type="text" name="attribute_key_{{ key }}" value="{{ key }}"
                            class="attribute-key-input input-field attribute-key-fixed-width" readonly>
                        <input type="text" name="attribute_value_{{ key }}" value="{{ value }}" placeholder="Wert"
                            class="attribute-input input-field">
                        <button type="button" class="delete-attribute icon-btn delete"
                            onclick="this.closest('.attribute-field').remove();">
                            <img src="{{ url_for('static', filename='img/icon_delete.svg') }}" alt="Entfernen">
                        </button>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>

            <div id="verknuepfung_container" class="kontakt-section">
                <h2>Verknüpfungen</h2>
                <div class="attribute-group" id="verknuepfung-group">
                    {% for verknuepfung in verknuepfungen %}
                    <div class="attribute-field">
                        <label>Verknüpfung</label>
                        <div class="verknuepfung-select-container">
                            <input type="hidden" name="verknuepfung_ids" value="{{ verknuepfung.id }}">
                            <input type="text" class="verknuepfung-display-input input-field"
                                value="{{ verknuepfung.vorname }} {{ verknuepfung.nachname }} ({% if verknuepfung.firma %}{{ verknuepfung.firma }}{% else %}ID:{{ verknuepfung.id }}{% endif %})"
                                readonly>
                            <button type="button" class="delete-attribute icon-btn delete"
                                onclick="removeVerknuepfung(this)">
                                <img src="{{ url_for('static', filename='img/icon_delete.svg') }}" alt="Entfernen">
                            </button>
                        </div>
                    </div>
                    {% endfor %}

                    <div class="attribute-field">
                        <label for="new_verknuepfung_select">Kontakt verknüpfen</label>
                        <input type="text" id="autocomplete-search-input" placeholder="Nach Kontakt suchen..."
                            class="autocomplete-search-input-field">
                        <select id="new_verknuepfung_select" class="autocomplete-select input-field"></select>
                    </div>

                </div>
            </div>
            <button type="button" id="addAttributeBtn" class="button add button-margin-top">
                <img src="{{ url_for('static', filename='img/icon_plus.svg') }}" alt="Hinzufügen"> Attribut hinzufügen
            </button>
        </div>

        <div class="modal-actions">
            <button type="submit" class="button">Speichern</button>
            {% if kontakt %}
            <a href="{{ url_for('kontakte.loeschen', kontakt_id=kontakt.id) }}" class="button danger"
                onclick="return confirm('Sicher?');">Kontakt löschen</a>
            {% endif %}
            <a href="{{ url_for('kontakte.auflisten') }}" class="button secondary">Abbrechen</a>
        </div>
    </form>
</div>


<div id="selectOptionModal" class="modal-overlay modal-edit-options">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Optionen bearbeiten</h2>
            <button type="button" onclick="closeModal()" class="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <h3 id="modal-key-title">Optionen für das Attribut</h3>
            <ul id="modal-options-list" class="option-list">
            </ul>
            <div class="add-option-container">
                <input type="text" id="newOptionInput" placeholder="Neue Option" class="input-field new-option-input">
                <button type="button" id="addOptionBtn" class="button add">Hinzufügen</button>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" id="saveOptionsBtn" class="button">Speichern</button>
        </div>

    </div>
</div>
<script type="application/json" id="selection-options-data">{{ selection_options|tojson|safe }}</script>
<script type="application/json" id="attribute-suggestions-data">{{ attribute_suggestions|tojson|safe }}</script>
<script type="application/json" id="contact-id-data">{{ kontakt.id|tojson if kontakt else 'null' }}</script>
<script>
    // Globale Funktionen für das HTML
    window.removeVerknuepfung = function (button) {
        button.closest('.attribute-field').remove();
    };
    window.closeModal = function () {
        document.getElementById("selectOptionModal").style.display = "none";
    };
</script>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/kontakt_editor.js') }}"></script>
{% endblock %}
{% extends "base.html" %}
{% block title %}Kontaktübersicht{% endblock %}

{% block content %}
<div id="kontakte-app">
    <div class="actions-header">
        <h1>Kontaktübersicht</h1>
        <div class="button-group">
            <button @click="openAddModal" class="button add">➕ Kontakt hinzufügen</button>
            <button @click="openImportModal" class="button secondary">↑ Aus MSG importieren</button>
        </div>
    </div>

    <div class="view-switcher">
        <label for="vorlagen-select" style="margin-right: 0.5rem; font-weight: 500;">Angezeigte Vorlage:</label>
        <select v-if="vorlagen.length > 0" v-model="activeVorlageId" id="vorlagen-select">
            <option v-for="vorlage in vorlagen" :value="vorlage.id" v-text="vorlage.name"></option>
        </select>
    </div>

    <div v-if="activeVorlage" class="card table-container">
        <table>
            <thead>
                <tr>
                    <th v-for="e in activeVorlage.eigenschaften" v-text="e.name"></th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="kontakt in activeVorlage.kontakte">
                    <td v-for="e in activeVorlage.eigenschaften"><input type="text" :value="kontakt.daten[e.name] || ''"
                            @blur="updateField(kontakt, e.name, $event.target.value)" class="inline-edit-input"></td>
                    <td class="actions"><a :href="'/kontakte/editor?kontakt_id=' + kontakt.id" class="icon-btn edit"
                            title="Im Formular bearbeiten">✏️</a></td>
                </tr>
            </tbody>
        </table>
    </div>
    <div v-if="!activeVorlage" class="card">
        <p>Keine Vorlagen gefunden. <a href="{{ url_for('vorlagen_verwalten') }}">Erstelle zuerst eine Vorlage.</a></p>
    </div>

    <div v-if="isAddModalOpen" class="modal-overlay" @click.self="closeAddModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Neuen Kontakt erstellen</h3>
                <button @click="closeAddModal" class="modal-close-btn">✖</button>
            </div>
            <form id="addContactForm" @submit.prevent="saveNewContact">
                <div class="form-group">
                    <label>Basierend auf Vorlage:</label>
                    <select v-model="addModalVorlageId" style="margin-bottom: 1rem;">
                        <option :value="null" disabled>Bitte Vorlage wählen...</option>
                        <option v-for="v in vorlagen" :value="v.id" v-text="v.name"></option>
                    </select>
                </div>
                <template v-if="addModalVorlage">
                    <div v-for="gruppe in addModalVorlage.gruppen" class="group-box">
                        <h4 v-text="gruppe.name"></h4>
                        <div v-for="eigenschaft in gruppe.eigenschaften" class="form-group">
                            <label v-text="eigenschaft.name"></label>
                            <input :type="eigenschaft.datentyp.toLowerCase()"
                                v-model="newContactData[eigenschaft.name]">
                        </div>
                    </div>
                </template>
            </form>
            <div class="actions">
                <button type="button" @click="closeAddModal" class="button secondary">Abbrechen</button>
                <button type="submit" form="addContactForm" class="button add">➕ Kontakt speichern</button>
            </div>
        </div>
    </div>

    <div v-if="isImportModalOpen" class="modal-overlay" @click.self="closeImportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Kontakte aus .msg-Dateien importieren</h3>
                <button @click="closeImportModal" class="modal-close-btn">&times;</button>
            </div>
            <form action="/import/msg" method="post" enctype="multipart/form-data">
                <fieldset>
                    <label>In welche Vorlage importieren?</label>
                    <select name="vorlage_id" required>
                        <option value="" disabled selected>-- Bitte wählen --</option>
                        <option v-for="v in vorlagen" :value="v.id" v-text="v.name"></option>
                    </select>
                </fieldset>
                <fieldset>
                    <label>.msg-Dateien auswählen:</label>
                    <input type="file" name="msg_files" multiple required accept=".msg">
                </fieldset>
                <div class="actions">
                    <button type="button" @click="closeImportModal" class="button secondary">Abbrechen</button>
                    <button type="submit" class="button">Hochladen & Importieren</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
    const { createApp, ref, computed, watch } = Vue;

    createApp({
        setup() {
            const vorlagen = ref(JSON.parse('{{ vorlagen_for_json|tojson|safe }}'));
            const isAddModalOpen = ref(false);
            const isImportModalOpen = ref(false);
            const newContactData = ref({});
            const activeVorlageId = ref(vorlagen.value.length > 0 ? vorlagen.value[0].id : null);
            const addModalVorlageId = ref(activeVorlageId.value);

            const activeVorlage = computed(() => vorlagen.value.find(v => v.id === activeVorlageId.value));
            const addModalVorlage = computed(() => vorlagen.value.find(v => v.id === addModalVorlageId.value));

            watch(addModalVorlageId, () => { newContactData.value = {}; });

            const openAddModal = () => { isAddModalOpen.value = true; };
            const closeAddModal = () => { isAddModalOpen.value = false; };
            const openImportModal = () => { isImportModalOpen.value = true; };
            const closeImportModal = () => { isImportModalOpen.value = false; };

            const updateField = async (kontakt, fieldName, newValue) => {
                if (kontakt.daten[fieldName] === newValue) return;
                try {
                    const response = await fetch(`/api/kontakt/${kontakt.id}/update`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ field: fieldName, value: newValue }) });
                    const result = await response.json();
                    if (result.success) {
                        kontakt.daten[fieldName] = newValue;
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error("Fehler:", error);
                    alert("Speichern fehlgeschlagen.");
                }
            };
            const saveNewContact = async () => {
                if (!addModalVorlageId.value) { alert("Bitte eine Vorlage auswählen."); return; }
                try {
                    const response = await fetch('/api/kontakt/neu', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ vorlage_id: addModalVorlageId.value, daten: newContactData.value }) });
                    const result = await response.json();
                    if (result.success) {
                        const targetVorlage = vorlagen.value.find(v => v.id === addModalVorlageId.value);
                        if (targetVorlage) {
                            targetVorlage.kontakte.push(result.kontakt);
                        }
                        closeAddModal();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error("Fehler:", error);
                    alert("Speichern fehlgeschlagen.");
                }
            };

            return { vorlagen, activeVorlageId, activeVorlage, addModalVorlageId, addModalVorlage, newContactData, isAddModalOpen, isImportModalOpen, openAddModal, closeAddModal, openImportModal, closeImportModal, updateField, saveNewContact };
        }
    }).mount('#kontakte-app');
</script>
<style>
    .view-switcher {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .table-container table {
        font-size: 0.85em;
    }

    .table-container th,
    .table-container td {
        padding: 0.2rem 0.5rem;
        white-space: nowrap;
    }

    .inline-edit-input {
        font-size: 1em;
        padding: 0.2rem 0.4rem;
        height: 28px;
        width: 100%;
        border: 1px solid transparent;
        background-color: transparent;
        border-radius: 4px;
    }

    .inline-edit-input:focus {
        border-color: var(--accent-color);
        background-color: var(--bg-main);
        outline: none;
    }

    .group-box {
        margin-bottom: 1.5rem;
        padding: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
    }

    .group-box h4 {
        margin-top: 0;
        font-size: 1em;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}
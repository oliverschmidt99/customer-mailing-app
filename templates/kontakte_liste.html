{% extends "base.html" %}
{% block title %}Kontaktübersicht{% endblock %}

{% block head_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/kontakte.css', v='1.4') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/filter.css', v='1.5') }}">
{% endblock %}

{% block content %}
<div id="kontakte-app">
    <div class="actions-header">
        <h1>Kontaktübersicht</h1>
        <div class="button-group">
            <button @click="openAddModal" class="button add">
                <img src="{{ url_for('static', filename='img/icon_plus.svg') }}" alt="Hinzufügen">
                Kontakt hinzufügen
            </button>
            <button @click="openImportModal" class="button secondary">
                <img src="{{ url_for('static', filename='img/icon_upload.svg') }}" alt="Importieren">
                Importieren
            </button>
            <div class="dropdown">
                <button class="button secondary">Exportieren</button>
                <div class="dropdown-content">
                    <a :href="getExportUrl('csv')">Als CSV</a>
                    <a :href="getExportUrl('xlsx')">Als Excel (.xlsx)</a>
                    <a :href="getExportUrl('pdf')">Als PDF (Druck)</a>
                </div>
            </div>
        </div>
    </div>

    <div v-if="isImportModalOpen" class="modal-overlay" @click.self="closeImportModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Kontakte importieren</h2>
                <button @click="closeImportModal" class="modal-close-btn">&times;</button>
            </div>

            <div v-if="importStep === 1">
                <div class="form-group">
                    <label for="import-vorlage-select">1. Ziel-Vorlage auswählen:</label>
                    <select v-model="importTargetVorlageId" id="import-vorlage-select">
                        <option disabled value="">Bitte eine Vorlage wählen</option>
                        <option v-for="v in vorlagen" :value="v.id">{[ v.name ]}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>2. Datei hochladen:</label>
                    <input type="file" @change="handleFileUpload" accept=".csv,.txt,.xlsx,.vcf,.msg,.oft,.rtf">
                </div>
                <div v-if="importError" class="alert-danger">{[ importError ]}</div>
            </div>

            <div v-if="importStep === 2 && importData.headers">
                <h4>3. Spalten zuordnen</h4>
                <p>Ordne die Spalten aus deiner Datei den Feldern der Vorlage zu.</p>
                <div class="mapping-grid">
                    <div class="mapping-header">Spalte aus Datei</div>
                    <div class="mapping-header">Feld in Vorlage</div>
                    <template v-for="header in importData.headers">
                        <div><strong>{[ header ]}</strong></div>
                        <div>
                            <select v-model="importMappings[header]">
                                <option value="">-- Ignorieren --</option>
                                <option v-for="prop in importTargetVorlage.eigenschaften" :value="prop.name">
                                    {[ prop.name ]}
                                </option>
                            </select>
                        </div>
                    </template>
                </div>
                <div class="data-preview">
                    <h5>Vorschau der ersten 5 Zeilen</h5>
                    <table>
                        <thead>
                            <tr>
                                <th v-for="h in importData.headers">{[ h ]}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="row in importData.preview_data">
                                <td v-for="h in importData.headers">{[ row[h] ]}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-actions">
                <button @click="closeImportModal" class="button secondary">Abbrechen</button>
                <button v-if="importStep === 2" @click="finalizeImport" class="button">Import starten</button>
            </div>
        </div>
    </div>

</div>
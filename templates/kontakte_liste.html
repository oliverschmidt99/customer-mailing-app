<!DOCTYPE html>
{% extends "base.html" %}
{% block title %}Kontaktübersicht{% endblock %}

{% block head_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/kontakte.css', v='2.0') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/filter.css', v='1.5') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/import_export.css', v='1.3') }}">
{% endblock %}

{% block content %}
<div id="kontakte-app">
    <div class="actions-header">
        <h1>Kontaktübersicht</h1>
        <div class="button-group">
            <div v-if="selectedKontakte.size > 0" class="bulk-actions">
                <button type="button" @click="bulkDelete" class="button danger">
                    <img src="{{ url_for('static', filename='img/icon_delete.svg') }}" alt="Löschen">
                    {[ selectedKontakte.size ]} Löschen
                </button>
            </div>
            <button type="button" @click="openAddModal" class="button add">
                <img src="{{ url_for('static', filename='img/icon_plus.svg') }}" alt="Hinzufügen">
                Kontakt hinzufügen
            </button>
            <button type="button" @click="openImportModal" class="button secondary">
                <img src="{{ url_for('static', filename='img/icon_upload.svg') }}" alt="Importieren">
                Importieren
            </button>
            <div class="dropdown">
                <button type="button" class="button secondary">Exportieren</button>
                <div class="dropdown-content">
                    <a :href="getExportUrl('csv')">Als CSV</a>
                    <a :href="getExportUrl('xlsx')">Als Excel (.xlsx)</a>
                    <a :href="getExportUrl('pdf')">Als PDF (Detailansicht)</a>
                    <a :href="getExportUrl('pdf-labels')">Als Adressaufkleber (PDF)</a>
                </div>
            </div>
        </div>
    </div>

    <div class="view-switcher">
        <select v-model="activeVorlageId" class="input-field select-vorlage">
            <option v-for="vorlage in vorlagen" :key="vorlage.id" :value="vorlage.id">{[ vorlage.name ]}</option>
        </select>
    </div>

    <div v-if="activeVorlage" class="filter-container">
        <div class="filter-header" @click="isFilterVisible = !isFilterVisible">
            <span :class="['toggle-icon', { collapsed: !isFilterVisible }]">▼</span>
            <h3>Filter &amp; Spaltenreihenfolge</h3>
            <button type="button" @click.stop="toggleEditOrderMode" class="button secondary filter-edit-button">
                <img src="{{ url_for('static', filename='img/icon_edit.svg') }}" alt="Reihenfolge bearbeiten">
                {[ editOrderMode ? 'Fertig' : 'Reihenfolge bearbeiten' ]}
            </button>
        </div>
        <div v-show="isFilterVisible" class="filter-body">
            <div v-for="gruppe in activeVorlage.gruppen" :key="gruppe.id" class="filter-group">
                <div class="filter-group-header" @click="toggleGroupFilter(gruppe)">
                    <img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" :src="getToggleIcon(gruppe)"
                        class="group-toggle" :class="getGroupToggleState(gruppe)" alt="Checkbox-Status">
                    <span v-if="editOrderMode" class="drag-handle">☰</span>
                    <span class="filter-group-title">{[ gruppe.name ]}</span>
                </div>
                <div class="filter-items-container" :id="'filter-group-' + gruppe.id">
                    <div v-for="eigenschaft in gruppe.eigenschaften" :key="eigenschaft.id" class="filter-item"
                        :class="{ active: filterState[eigenschaft.name] }"
                        @click="filterState[eigenschaft.name] = !filterState[eigenschaft.name]">
                        <span v-if="editOrderMode" class="drag-handle">☰</span>
                        {[ eigenschaft.name ]}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="activeVorlage" class="table-container">
        <table>
            <thead>
                <tr>
                    <th class="checkbox-col sticky-col">
                        <input type="checkbox" :checked="isAllSelected" @change="toggleSelectAll">
                    </th>
                    <th v-for="eigenschaft in filteredEigenschaften" :key="eigenschaft.id"
                        @click="sortBy(eigenschaft.name)" class="sortable">
                        {[ eigenschaft.name ]}
                        <span v-if="sortColumn === eigenschaft.name">{[ sortDirection === 'asc' ? '▲' : '▼' ]}</span>
                    </th>
                    <th class="actions-col sticky-col">Aktionen</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="kontakt in sortedKontakte" :key="kontakt.id"
                    :class="{ selected: selectedKontakte.has(kontakt.id) }">
                    <td class="checkbox-col sticky-col">
                        <input type="checkbox" :checked="selectedKontakte.has(kontakt.id)"
                            @change="toggleSelection(kontakt.id)">
                    </td>
                    <td v-for="eigenschaft in filteredEigenschaften" :key="eigenschaft.id">

                        <div v-if="eigenschaft.datentyp === 'Auswahl' && eigenschaft.allow_multiselect"
                            class="multiselect-display" @click="openMultiSelectModal(eigenschaft, kontakt)"
                            title="Klicken zum Bearbeiten">
                            <span class="multiselect-values">
                                {[ kontakt.daten[eigenschaft.name] || '--' ]}
                            </span>
                            <span class="multiselect-icon">▼</span>
                        </div>

                        <input v-else-if="eigenschaft.datentyp === 'Text'" type="text" class="inline-edit-input"
                            :value="kontakt.daten[eigenschaft.name]"
                            @change="updateField(kontakt, eigenschaft.name, $event.target.value)">
                        <select v-else-if="eigenschaft.datentyp === 'Auswahl'" class="inline-select"
                            :value="kontakt.daten[eigenschaft.name]"
                            @change="updateField(kontakt, eigenschaft.name, $event.target.value)">
                            <option value="">-- Bitte wählen --</option>
                            <option v-for="option in eigenschaft.optionen.split(',')" :key="option"
                                :value="option.trim()">{[ option.trim() ]}</option>
                        </select>
                        <select
                            v-else-if="eigenschaft.datentyp === 'Verknüpfung' && verknuepfungsOptionen[eigenschaft.id]"
                            class="inline-select" :value="kontakt.daten[eigenschaft.name]"
                            @change="updateField(kontakt, eigenschaft.name, $event.target.value)">
                            <option value="">-- Keine Verknüpfung --</option>
                            <option v-for="option in verknuepfungsOptionen[eigenschaft.id]" :key="option.id"
                                :value="option.id">
                                {[ option.display_name ]}
                            </option>
                        </select>
                        <span v-else>{[ kontakt.daten[eigenschaft.name] ]}</span>
                    </td>
                    <td class="actions-col sticky-col">
                        <div class="actions">
                            <a :href="'/kontakte/editor?kontakt_id=' + kontakt.id" class="icon-btn edit"
                                title="Bearbeiten">
                                <img src="{{ url_for('static', filename='img/icon_edit.svg') }}" alt="Bearbeiten">
                            </a>
                            <form :action="'/kontakte/loeschen/' + kontakt.id" method="post"
                                onsubmit="return confirm('Sicher?');">
                                <button type="submit" class="icon-btn delete" title="Löschen">
                                    <img src="{{ url_for('static', filename='img/icon_delete.svg') }}" alt="Löschen">
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div v-else>
        <p>Keine Vorlage ausgewählt oder vorhanden.</p>
    </div>

    <div v-if="isAddModalOpen" class="modal-overlay">
        <div class="modal-content modal-xlarge">
            <div class="modal-header">
                <h2>Neuen Kontakt erstellen</h2>
                <button type="button" @click="closeAddModal" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="add-vorlage-select">Vorlage:</label>
                    <select id="add-vorlage-select" v-model="addModalVorlageId" class="input-field">
                        <option v-for="v in vorlagen" :key="v.id" :value="v.id">{[ v.name ]}</option>
                    </select>
                </div>
                <hr>

                <div v-if="addModalVorlage" class="modal-form-columns">
                    <div v-for="gruppe in addModalVorlage.gruppen" :key="gruppe.id" class="form-group-box">
                        <h4 class="form-group-title">{[ gruppe.name ]}</h4>
                        <div v-for="e in gruppe.eigenschaften" :key="e.id" class="form-group">
                            <label :for="'new-contact-' + e.name">{[ e.name ]}:</label>

                            <select v-if="e.datentyp === 'Auswahl' && e.allow_multiselect" :id="'new-contact-' + e.name"
                                v-model="newContactData[e.name]" class="input-field" multiple>
                                <option v-for="option in e.optionen.split(',')" :key="option.trim()"
                                    :value="option.trim()">
                                    {[ option.trim() ]}
                                </option>
                            </select>

                            <select v-else-if="e.datentyp === 'Auswahl'" :id="'new-contact-' + e.name"
                                v-model="newContactData[e.name]" class="input-field">
                                <option value="">-- Bitte wählen --</option>
                                <option v-for="option in e.optionen.split(',')" :key="option.trim()"
                                    :value="option.trim()">
                                    {[ option.trim() ]}
                                </option>
                            </select>

                            <input v-else-if="e.datentyp === 'Datum'" :id="'new-contact-' + e.name" type="date"
                                v-model="newContactData[e.name]" class="input-field">

                            <input v-else :id="'new-contact-' + e.name" type="text" v-model="newContactData[e.name]"
                                class="input-field">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" @click="closeAddModal" class="button secondary">Abbrechen</button>
                <button type="button" @click="saveNewContact" class="button">Speichern</button>
            </div>
        </div>
    </div>

    <div v-if="isImportModalOpen" class="modal-overlay">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>{[ importStep === 1 ? 'Daten importieren (Schritt 1/2)' : 'Daten zuordnen (Schritt 2/2)' ]}</h2>
                <button type="button" @click="closeImportModal" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div v-if="importStep === 1">
                    <div class="form-group">
                        <label for="import-vorlage-select">Ziel-Vorlage für den Import:</label>
                        <select id="import-vorlage-select" v-model="importTargetVorlageId" class="input-field">
                            <option disabled :value="null">Bitte Vorlage wählen...</option>
                            <option v-for="v in vorlagen" :key="v.id" :value="v.id">{[ v.name ]}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="import-file-input">Datei(en) auswählen:</label>
                        <input type="file" id="import-file-input" @change="handleFileUpload" class="input-field"
                            :disabled="!importTargetVorlageId || isUploading" multiple
                            accept=".csv,.msg,.oft,.txt,.vcf,.xlsx">
                    </div>

                    <div v-if="isUploading" class="progress-container">
                        <div class="progress-bar" :style="{ width: uploadProgress + '%' }"></div>
                        <span class="progress-text">{[ uploadStatus ]}</span>
                    </div>

                    <div v-if="importError" class="alert-danger">{[ importError ]}</div>
                </div>

                <div v-if="importStep === 2 && importTargetVorlage">

                    <div v-if="!isFinalMappingStep">
                        <p>
                            Bitte ordne die Felder für die Gruppe <strong>"{[ currentMappingGroup.name ]}"</strong> zu.
                            <span class="step-indicator">Schritt {[ mappingStep + 1 ]} von {[ totalMappingSteps
                                ]}</span>
                        </p>
                        <div class="mapping-grid">
                            <div class="mapping-header">Feld in Vorlage</div>
                            <div class="mapping-header">Spalte aus Datei</div>
                            <template v-for="prop in currentMappingGroup.eigenschaften" :key="prop.id">
                                <div class="template-field-cell">
                                    <strong>{[ prop.name ]}</strong>
                                </div>
                                <div>
                                    <select :ref="el => { tomSelectRefs[prop.name] = el }"
                                        v-model="importMappings[prop.name]">
                                        <option value="">-- Ignorieren --</option>
                                        <option v-for="header in importData.headers" :key="header" :value="header">
                                            {[ header ]}
                                        </option>
                                    </select>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div v-if="isFinalMappingStep">
                        <p>
                            Bitte überprüfe die gesamte Zuordnung vor dem Abschluss.
                            <span class="step-indicator">Schritt {[ mappingStep + 1 ]} von {[ totalMappingSteps
                                ]}</span>
                        </p>
                        <div class="form-group mapping-search-container">
                            <input type="text" v-model="mappingSearchQuery" placeholder="Vorlagen-Feld suchen..."
                                class="input-field">
                        </div>
                        <div class="mapping-grid">
                            <div class="mapping-header">Feld in Vorlage</div>
                            <div class="mapping-header">Spalte aus Datei</div>
                            <template v-for="gruppe in importTargetVorlage.gruppen" :key="gruppe.id">
                                <template v-for="prop in gruppe.eigenschaften" :key="prop.id">
                                    <div v-if="filteredTemplateProperties.some(p => p.id === prop.id)"
                                        class="template-field-cell">
                                        <span class="group-label">{[ gruppe.name ]}</span>
                                        <strong>{[ prop.name ]}</strong>
                                    </div>
                                    <div v-if="filteredTemplateProperties.some(p => p.id === prop.id)">
                                        <select :ref="el => { tomSelectRefs[prop.name] = el }"
                                            v-model="importMappings[prop.name]">
                                            <option value="">-- Ignorieren --</option>
                                            <option v-for="header in importData.headers" :key="header" :value="header">
                                                {[ header ]}
                                            </option>
                                        </select>
                                    </div>
                                </template>
                            </template>
                            <div v-if="filteredTemplateProperties.length === 0" class="no-results-message">
                                Keine Felder für "{[ mappingSearchQuery ]}" gefunden.
                            </div>
                        </div>
                    </div>

                    <div v-if="importError" class="alert-danger error-margin-top">{[ importError ]}</div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" @click="closeImportModal" class="button secondary">Abbrechen</button>
                <button type="button" v-if="importStep === 2" @click="prevMappingStep" :disabled="mappingStep === 0"
                    class="button secondary">Zurück</button>
                <button type="button" v-if="importStep === 2 && !isFinalMappingStep" @click="nextMappingStep"
                    class="button">Weiter</button>
                <button type="button" v-if="importStep === 2 && isFinalMappingStep" @click="finalizeImport"
                    class="button">Import abschließen</button>
            </div>
        </div>
    </div>

    <div v-if="isMultiSelectModalOpen" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 v-if="multiSelectEditData.eigenschaft">Werte für "{[ multiSelectEditData.eigenschaft.name ]}"
                    auswählen</h2>
                <button type="button" @click="isMultiSelectModalOpen = false" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body multiselect-modal-body" v-if="multiSelectEditData.eigenschaft">
                <div v-for="option in multiSelectEditData.eigenschaft.optionen.split(',')" :key="option.trim()"
                    class="checkbox-item">
                    <input type="checkbox" :id="'ms-opt-' + option.trim()" :value="option.trim()"
                        v-model="multiSelectEditData.selectedValues" class="multiselect-checkbox">
                    <label :for="'ms-opt-' + option.trim()">{[ option.trim() ]}</label>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" @click="isMultiSelectModalOpen = false"
                    class="button secondary">Abbrechen</button>
                <button type="button" @click="saveMultiSelect" class="button">Speichern</button>
            </div>
        </div>
    </div>
</div>

<script type="application/json" id="vorlagen-for-json-data">{{ vorlagen_for_json|safe }}</script>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script src="{{ url_for('static', filename='js/kontakte_liste.js') }}"></script>
{% endblock %}
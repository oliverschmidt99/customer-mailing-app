<!DOCTYPE html>
{% extends "base.html" %}
{% block title %}Kontaktübersicht{% endblock %}

{% block head_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/kontakte.css', v='1.4') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/filter.css', v='1.5') }}">
<style>
    /* Zusätzliche Stile für Import/Export */
    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        background-color: var(--card-bg);
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px var(--shadow-color);
        z-index: 1;
        border-radius: 6px;
        border: 1px solid var(--border-color);
    }

    .dropdown-content a {
        color: var(--text-primary);
        padding: 12px 16px;
        text-decoration: none;
        display: block;
    }

    .dropdown-content a:hover {
        background-color: var(--card-active-bg);
    }

    .dropdown:hover .dropdown-content {
        display: block;
    }

    .alert-danger {
        color: #dc3545;
        background-color: #f8d7da;
        border-color: #f5c6cb;
        padding: .75rem 1.25rem;
        margin-top: 1rem;
        border: 1px solid transparent;
        border-radius: .25rem;
    }

    .mapping-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1rem;
    }

    .mapping-header {
        font-weight: bold;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.5rem;
    }

    .data-preview {
        margin-top: 1.5rem;
    }

    .data-preview table {
        font-size: 0.8em;
    }
</style>
{% endblock %}

{% block content %}
<div id="kontakte-app">
    <div class="actions-header">
        <h1>Kontaktübersicht</h1>
        <div class="button-group">
            <button @click="openAddModal" class="button add">
                <img src="{{ url_for('static', filename='img/icon_plus.svg') }}" alt="Hinzufügen">
                Kontakt hinzufügen
            </button>
            <button @click="openImportModal" class="button secondary">
                <img src="{{ url_for('static', filename='img/icon_upload.svg') }}" alt="Importieren">
                Importieren
            </button>
            <div class="dropdown">
                <button class="button secondary">Exportieren</button>
                <div class="dropdown-content">
                    <a :href="getExportUrl('csv')" download>Als CSV</a>
                    <a :href="getExportUrl('xlsx')" download>Als Excel (.xlsx)</a>
                    <a :href="getExportUrl('pdf')" download>Als PDF (Druck)</a>
                </div>
            </div>
        </div>
    </div>

    <div class="view-switcher">
        <label for="vorlagen-select">Angezeigte Vorlage:</label>
        <select v-if="vorlagen.length > 0" v-model="activeVorlageId" id="vorlagen-select">
            <option v-for="vorlage in vorlagen" :value="vorlage.id" v-text="vorlage.name"></option>
        </select>
    </div>

    <div v-if="activeVorlage" class="filter-container">
        <div class="filter-header" @click="isFilterVisible = !isFilterVisible">
            <h3>Spaltenfilter</h3>
            <div style="display: flex; align-items: center;">
                <button v-if="isFilterVisible" @click.stop="toggleEditOrderMode"
                    class="button secondary filter-edit-button" :class="{ 'active': editOrderMode }">
                    <img src="{{ url_for('static', filename='img/icon_edit.svg') }}" alt="Bearbeiten">
                    {[ editOrderMode ? 'Fertig' : 'Reihenfolge ändern' ]}
                </button>
                <svg class="toggle-icon" :class="{ collapsed: !isFilterVisible }" xmlns="http://www.w3.org/2000/svg"
                    width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
        </div>
        <div v-if="isFilterVisible" class="filter-body">
            <div v-for="gruppe in activeVorlage.gruppen" class="filter-group" :key="gruppe.id">
                <div class="filter-group-header" @click="!editOrderMode && toggleGroupFilter(gruppe)">
                    <span v-if="editOrderMode" class="drag-handle">⠿</span>
                    <img v-else :src="getToggleIcon(gruppe)" :class="getGroupToggleState(gruppe)" class="group-toggle"
                        alt="Toggle Group">
                    <span class="filter-group-title">{[ gruppe.name ]}</span>
                </div>
                <div class="filter-items-container" :id="'filter-group-' + gruppe.id">
                    <div v-for="eigenschaft in gruppe.eigenschaften" class="filter-item"
                        :class="{ active: filterState[eigenschaft.name] }"
                        @click="!editOrderMode && (filterState[eigenschaft.name] = !filterState[eigenschaft.name])">
                        <span v-if="editOrderMode" class="drag-handle">⠿</span>
                        {[ eigenschaft.name ]}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="activeVorlage" class="card table-container">
        <table>
            <thead>
                <tr>
                    <th v-for="e in filteredEigenschaften">{[ e.name ]}</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody>
                <tr v-if="activeVorlage.kontakte.length > 0" v-for="kontakt in activeVorlage.kontakte"
                    :key="kontakt.id">
                    <td v-for="e in filteredEigenschaften">
                        <span v-if="e.datentyp === 'Boolean'">
                            <input type="checkbox" :checked="kontakt.daten[e.name]"
                                @change="updateField(kontakt, e.name, $event.target.checked)" class="inline-edit-input">
                        </span>
                        <select v-else-if="e.datentyp === 'Auswahl'" class="inline-select"
                            @change="updateField(kontakt, e.name, $event.target.value)">
                            <option v-for="option in e.optionen.split(',')" :value="option.trim()"
                                :selected="option.trim() == kontakt.daten[e.name]">{[ option.trim() ]}</option>
                        </select>
                        <input v-else :type="e.datentyp.toLowerCase() === 'zahl' ? 'number' : 'text'"
                            :value="kontakt.daten[e.name]" @change="updateField(kontakt, e.name, $event.target.value)"
                            class="inline-edit-input">
                    </td>
                    <td class="actions">
                        <a :href="'/kontakte/editor?kontakt_id=' + kontakt.id" class="icon-btn edit"
                            title="Kontakt bearbeiten">
                            <img src="{{ url_for('static', filename='img/icon_edit.svg') }}" alt="Bearbeiten">
                        </a>
                        <form :action="'/kontakte/loeschen/' + kontakt.id" method="post"
                            onsubmit="return confirm('Bist du sicher, dass du diesen Kontakt löschen möchtest?');">
                            <button type="submit" class="icon-btn delete" title="Kontakt löschen">
                                <img src="{{ url_for('static', filename='img/icon_delete.svg') }}" alt="Löschen">
                            </button>
                        </form>
                    </td>
                </tr>
                <tr v-else>
                    <td :colspan="filteredEigenschaften.length + 1" style="text-align: center; padding: 2rem;">
                        Für diese Vorlage wurden noch keine Kontakte erstellt.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div v-if="!activeVorlage" class="card">
        <p>Keine Vorlagen gefunden. Bitte erstelle zuerst eine unter "Vorlagen".</p>
    </div>

    <div v-if="isAddModalOpen" class="modal-overlay" @click.self="closeAddModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Neuen Kontakt erstellen</h2>
                <button @click="closeAddModal" class="modal-close-btn">&times;</button>
            </div>
            <div class="form-group">
                <label for="add-vorlage-select">Vorlage auswählen</label>
                <select v-model="addModalVorlageId" id="add-vorlage-select" class="form-control">
                    <option disabled value="">Bitte eine Vorlage wählen</option>
                    <option v-for="vorlage in vorlagen" :value="vorlage.id">{[ vorlage.name ]}</option>
                </select>
            </div>
            <div v-if="addModalVorlage">
                <div v-for="gruppe in addModalVorlage.gruppen" class="group-box">
                    <h4>{[ gruppe.name ]}</h4>
                    <div v-for="eigenschaft in gruppe.eigenschaften" class="form-group">
                        <label>{[ eigenschaft.name ]}</label>
                        <input v-if="['Text', 'Zahl', 'Datum', 'Email', 'Tel'].includes(eigenschaft.datentyp)"
                            :type="eigenschaft.datentyp.toLowerCase()" v-model="newContactData[eigenschaft.name]">
                        <select v-else-if="eigenschaft.datentyp === 'Auswahl'"
                            v-model="newContactData[eigenschaft.name]">
                            <option disabled value="">Bitte wählen...</option>
                            <option v-for="option in eigenschaft.optionen.split(',')" :value="option.trim()">{[
                                option.trim() ]}</option>
                        </select>
                        <input v-else-if="eigenschaft.datentyp === 'Boolean'" type="checkbox"
                            v-model="newContactData[eigenschaft.name]">
                        <select v-else-if="eigenschaft.datentyp === 'Verknüpfung'"
                            v-model="newContactData[eigenschaft.name]">
                            <option disabled value="">Bitte wählen...</option>
                            <option v-for="option in verknuepfungsOptionen[eigenschaft.id]" :value="option.id">
                                {[ option.display_name ]}
                            </option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button @click="closeAddModal" class="button secondary">Abbrechen</button>
                <button @click="saveNewContact" class="button">Kontakt Speichern</button>
            </div>
        </div>
    </div>

    <div v-if="isImportModalOpen" class="modal-overlay" @click.self="closeImportModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Kontakte importieren</h2>
                <button @click="closeImportModal" class="modal-close-btn">&times;</button>
            </div>
            <div v-if="importStep === 1">
                <div class="form-group">
                    <label for="import-vorlage-select">1. Ziel-Vorlage auswählen:</label>
                    <select v-model="importTargetVorlageId" id="import-vorlage-select">
                        <option disabled value="">Bitte eine Vorlage wählen</option>
                        <option v-for="v in vorlagen" :value="v.id">{[ v.name ]}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>2. Datei hochladen (csv, txt, xlsx, vcf):</label>
                    <input type="file" @change="handleFileUpload" accept=".csv,.txt,.xlsx,.vcf">
                </div>
                <div v-if="importError" class="alert-danger">{[ importError ]}</div>
            </div>
            <div v-if="importStep === 2 && importData.headers">
                <h4>3. Spalten zuordnen</h4>
                <p>Ordne die Spalten aus deiner Datei den Feldern der Vorlage zu.</p>
                <div class="mapping-grid">
                    <div class="mapping-header">Spalte aus Datei</div>
                    <div class="mapping-header">Feld in Vorlage</div>
                    <template v-for="header in importData.headers">
                        <div><strong>{[ header ]}</strong></div>
                        <div>
                            <select v-model="importMappings[header]">
                                <option value="">-- Ignorieren --</option>
                                <option v-for="prop in importTargetVorlage.eigenschaften" :value="prop.name">
                                    {[ prop.name ]}
                                </option>
                            </select>
                        </div>
                    </template>
                </div>
                <div class="data-preview">
                    <h5>Vorschau der ersten 5 Zeilen</h5>
                    <table class="table-container">
                        <thead>
                            <tr>
                                <th v-for="h in importData.headers">{[ h ]}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="row in importData.preview_data">
                                <td v-for="h in importData.headers">{[ row[h] ]}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-actions">
                <button @click="closeImportModal" class="button secondary">Abbrechen</button>
                <button v-if="importStep === 2" @click="finalizeImport" class="button">Import starten</button>
            </div>
        </div>
    </div>
</div>

<script type="application/json" id="vorlagen-for-json-data">{{ vorlagen_for_json|safe }}</script>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="{{ url_for('static', filename='js/kontakte_liste.js') }}"></script>
{% endblock %}
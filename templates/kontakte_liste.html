<!DOCTYPE html>
{% extends "base.html" %}
{% block title %}Kontaktübersicht{% endblock %}

{% block head_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/kontakte.css', v='1.4') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/filter.css', v='1.5') }}">
<style>
    /* Zusätzliche Stile für Import/Export */
    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        background-color: var(--card-bg);
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px var(--shadow-color);
        z-index: 1;
        border-radius: 6px;
        border: 1px solid var(--border-color);
    }

    .dropdown-content a {
        color: var(--text-primary);
        padding: 12px 16px;
        text-decoration: none;
        display: block;
    }

    .dropdown-content a:hover {
        background-color: var(--card-active-bg);
    }

    .dropdown:hover .dropdown-content {
        display: block;
    }

    .alert-danger {
        color: #dc3545;
        background-color: #f8d7da;
        border-color: #f5c6cb;
        padding: .75rem 1.25rem;
        margin-top: 1rem;
        border: 1px solid transparent;
        border-radius: .25rem;
    }

    .mapping-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1rem;
    }

    .mapping-header {
        font-weight: bold;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.5rem;
    }

    .data-preview {
        margin-top: 1.5rem;
    }

    .data-preview table {
        font-size: 0.8em;
    }
</style>
{% endblock %}

{% block content %}
<div id="kontakte-app">
    <div class="actions-header">
        <h1>Kontaktübersicht</h1>
        <div class="button-group">
            <button @click="openAddModal" class="button add">
                <img src="{{ url_for('static', filename='img/icon_plus.svg') }}" alt="Hinzufügen">
                Kontakt hinzufügen
            </button>
            <button @click="openImportModal" class="button secondary">
                <img src="{{ url_for('static', filename='img/icon_upload.svg') }}" alt="Importieren">
                Importieren
            </button>
            <div class="dropdown">
                <button class="button secondary">Exportieren</button>
                <div class="dropdown-content">
                    <a :href="getExportUrl('csv')" download>Als CSV</a>
                    <a :href="getExportUrl('xlsx')" download>Als Excel (.xlsx)</a>
                    <a :href="getExportUrl('pdf')" download>Als PDF (Druck)</a>
                </div>
            </div>
        </div>
    </div>

    <div class="view-switcher">
        <label for="vorlagen-select">Angezeigte Vorlage:</label>
        <select v-if="vorlagen.length > 0" v-model="activeVorlageId" id="vorlagen-select">
            <option v-for="vorlage in vorlagen" :value="vorlage.id" v-text="vorlage.name"></option>
        </select>
    </div>

    <div v-if="isImportModalOpen" class="modal-overlay" @click.self="closeImportModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Kontakte importieren</h2>
                <button @click="closeImportModal" class="modal-close-btn">&times;</button>
            </div>

            <div v-if="importStep === 1">
                <div class="form-group">
                    <label for="import-vorlage-select">1. Ziel-Vorlage auswählen:</label>
                    <select v-model="importTargetVorlageId" id="import-vorlage-select">
                        <option disabled value="">Bitte eine Vorlage wählen</option>
                        <option v-for="v in vorlagen" :value="v.id">{[ v.name ]}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>2. Datei hochladen (csv, txt, xlsx, vcf):</label>
                    <input type="file" @change="handleFileUpload" accept=".csv,.txt,.xlsx,.vcf">
                </div>
                <div v-if="importError" class="alert-danger">{[ importError ]}</div>
            </div>

            <div v-if="importStep === 2 && importData.headers">
                <h4>3. Spalten zuordnen</h4>
                <p>Ordne die Spalten aus deiner Datei den Feldern der Vorlage zu.</p>
                <div class="mapping-grid">
                    <div class="mapping-header">Spalte aus Datei</div>
                    <div class="mapping-header">Feld in Vorlage</div>
                    <template v-for="header in importData.headers">
                        <div><strong>{[ header ]}</strong></div>
                        <div>
                            <select v-model="importMappings[header]">
                                <option value="">-- Ignorieren --</option>
                                <option v-for="prop in importTargetVorlage.eigenschaften" :value="prop.name">
                                    {[ prop.name ]}
                                </option>
                            </select>
                        </div>
                    </template>
                </div>
                <div class="data-preview">
                    <h5>Vorschau der ersten 5 Zeilen</h5>
                    <table class="table-container">
                        <thead>
                            <tr>
                                <th v-for="h in importData.headers">{[ h ]}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="row in importData.preview_data">
                                <td v-for="h in importData.headers">{[ row[h] ]}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-actions">
                <button @click="closeImportModal" class="button secondary">Abbrechen</button>
                <button v-if="importStep === 2" @click="finalizeImport" class="button">Import starten</button>
            </div>
        </div>
    </div>
</div>

<script type="application/json" id="vorlagen-for-json-data">{{ vorlagen_for_json|safe }}</script>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="{{ url_for('static', filename='js/kontakte_liste.js') }}"></script>
{% endblock %}
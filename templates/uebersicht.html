<!DOCTYPE html>
{% extends 'base.html' %}
{% block title %}Kundenübersicht{% endblock %}

{% block content %}
<h1>Kundenübersicht & Filter</h1>
<div class="card config-section active">
    <form method="get" action="{{ url_for('uebersicht') }}">
        <div class="filter-grid">
            <div class="form-group">
                <label for="mitarbeiter_id">Mitarbeiter</label>
                <select name="mitarbeiter_id" id="mitarbeiter_id" onchange="this.form.submit()">
                    <option value="">Alle Mitarbeiter</option>
                    {% for m in mitarbeiter_liste %}
                    <option value="{{ m.id }}" {% if aktiver_mitarbeiter==m.id|string %}selected{% endif %}>
                        {{ m.vorname }} {{ m.nachname }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="benachrichtigungsart">Benachrichtigungsart (für {{ aktives_jahr }})</label>
                <select name="benachrichtigungsart" id="benachrichtigungsart" onchange="this.form.submit()">
                    <option value="">Alle Arten</option>
                    <option value="brief" {% if aktive_benachrichtigungsart=='brief' %}selected{% endif %}>Brief
                    </option>
                    <option value="kalender" {% if aktive_benachrichtigungsart=='kalender' %}selected{% endif %}>
                        Kalender</option>
                    <option value="email_versand" {% if aktive_benachrichtigungsart=='email_versand' %}selected{% endif
                        %}>E-Mail
                    </option>
                    <option value="speziell" {% if aktive_benachrichtigungsart=='speziell' %}selected{% endif %}>
                        Spezielle Benachrichtigung
                    </option>
                </select>
            </div>
            <div class="form-group">
                <label for="status">Status</label>
                <select name="status" id="status" onchange="this.form.submit()">
                    <option value="">Alle Status</option>
                    {% for s in status_optionen %}
                    <option value="{{ s }}" {% if aktiver_status==s %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </form>
</div>

<div class="card config-section active">
    <h2>Spalten ein-/ausblenden</h2>
    <div id="column-toggler" class="column-toggler"></div>
</div>

<div class="card config-section active">
    <h2>Gefilterte Kunden ({{ kunden|length }})</h2>
    <div class="table-container">
        <table id="overview-table">
            <thead>
                <tr>
                </tr>
            </thead>
            <tbody>
                {% for k in kunden %}
                <tr>
                    <td class="col-id">{{ k.id }}</td>
                    <td class="col-status">{{ status_emojis.get(k.status, '') }} {{ k.status }}</td>
                    <td class="col-mitarbeiter"
                        style="background-color: {{ k.mitarbeiter.farbe if k.mitarbeiter else 'transparent' }};">
                        {% if k.mitarbeiter %}{{ k.mitarbeiter.nachname }}{% else %}---{% endif %}
                    </td>
                    <td class="col-anrede">{{ k.anrede or '' }}</td>
                    <td class="col-titel">{{ k.titel or '' }}</td>
                    <td class="col-vorname">{{ k.vorname or '' }}</td>
                    <td class="col-nachname">{{ k.nachname or '' }}</td>
                    <td class="col-firma1">{{ k.firma1 or '' }}</td>
                    <td class="col-firma2">{{ k.firma2 or '' }}</td>
                    <td class="col-funktion">{{ k.funktion or '' }}</td>
                    <td class="col-abteilung">{{ k.abteilung or '' }}</td>
                    <td class="col-strasse">{{ k.strasse or '' }}</td>
                    <td class="col-plz">{{ k.postleitzahl or '' }}</td>
                    <td class="col-ort">{{ k.ort or '' }}</td>
                    <td class="col-land">{{ k.land or '' }}</td>
                    <td class="col-anschriftswahl">{{ k.anschriftswahl or '' }}</td>
                    <td class="col-email">{{ k.email or '' }}</td>
                    <td class="col-tel-beruflich">{{ k.telefon_beruflich or '' }}</td>
                    <td class="col-durchwahl">{{ k.durchwahl_buero or '' }}</td>
                    <td class="col-mobil">{{ k.mobil_telefon or '' }}</td>
                    <td class="col-fax">{{ k.faxnummer or '' }}</td>
                    <td class="col-tel-privat">{{ k.telefon_privat or '' }}</td>
                    <td class="col-anmerkungen" title="{{ k.anmerkungen or '' }}">{{ (k.anmerkungen[:30] + '...') if
                        k.anmerkungen and k.anmerkungen|length > 30 else (k.anmerkungen or '') }}</td>
                    <td class="actions col-aktionen">
                        <a href="{{ url_for('kunde_bearbeiten', id=k.id) }}" class="button secondary">Bearbeiten</a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td id="no-customer-cell" colspan="24">Keine Kunden für die aktuellen Filter gefunden.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const table = document.getElementById('overview-table');
        const toggler = document.getElementById('column-toggler');
        const noCustomerCell = document.getElementById('no-customer-cell');

        const allColumns = [
            { class: 'col-id', text: 'ID' }, { class: 'col-status', text: 'Status' },
            { class: 'col-mitarbeiter', text: 'Mitarbeiter' }, { class: 'col-anrede', text: 'Anrede' },
            { class: 'col-titel', text: 'Titel' }, { class: 'col-vorname', text: 'Vorname' },
            { class: 'col-nachname', text: 'Nachname' }, { class: 'col-firma1', text: 'Firma 1' },
            { class: 'col-firma2', text: 'Firma 2' }, { class: 'col-funktion', text: 'Funktion' },
            { class: 'col-abteilung', text: 'Abteilung' }, { class: 'col-strasse', text: 'Straße' },
            { class: 'col-plz', text: 'PLZ' }, { class: 'col-ort', text: 'Ort' },
            { class: 'col-land', text: 'Land' }, { class: 'col-anschriftswahl', text: 'Anschriftswahl' },
            { class: 'col-email', text: 'E-Mail' }, { class: 'col-tel-beruflich', text: 'Telefon (berufl.)' },
            { class: 'col-durchwahl', text: 'Durchwahl' }, { class: 'col-mobil', text: 'Mobil' },
            { class: 'col-fax', text: 'Fax' }, { class: 'col-tel-privat', text: 'Telefon (privat)' },
            { class: 'col-anmerkungen', text: 'Anmerkungen' }, { class: 'col-aktionen', text: 'Aktionen' }
        ];

        const STORAGE_KEY = 'kundenkommunikation_column_visibility';
        let visibility = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};

        function applyVisibility() {
            const theadTr = table.querySelector('thead tr');
            theadTr.innerHTML = '';
            let visibleColumnCount = 0;

            allColumns.forEach(col => {
                const isVisible = visibility[col.class] !== false;
                if (isVisible) {
                    const th = document.createElement('th');
                    th.className = col.class;
                    th.textContent = col.text;
                    theadTr.appendChild(th);
                    visibleColumnCount++;
                }

                table.querySelectorAll(`tbody .${col.class}`).forEach(cell => {
                    cell.style.display = isVisible ? '' : 'none';
                });
            });

            if (noCustomerCell) {
                noCustomerCell.setAttribute('colspan', visibleColumnCount);
            }
        }

        allColumns.forEach(col => {
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';

            const isVisibleByDefault = ['col-id', 'col-status', 'col-mitarbeiter', 'col-nachname', 'col-vorname', 'col-firma1', 'col-email', 'col-aktionen'].includes(col.class);

            if (visibility[col.class] === undefined) {
                visibility[col.class] = isVisibleByDefault;
            }
            checkbox.checked = visibility[col.class];

            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(col.text));
            toggler.appendChild(label);

            checkbox.addEventListener('change', () => {
                visibility[col.class] = checkbox.checked;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(visibility));
                applyVisibility();
            });
        });

        // Initial anwenden
        applyVisibility();
    });
</script>
{% endblock %}
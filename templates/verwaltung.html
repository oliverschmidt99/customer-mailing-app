{% extends "base.html" %}
{% block title %}Verwaltung{% endblock %}

{% block content %}
<h1>Verwaltung</h1>
<p>Wähle einen Bereich aus, um Mitarbeiter oder Kunden zu verwalten.</p>

<!-- Kachel-Navigation: Nur diese Karten sind interaktiv -->
<div class="card-container" id="verwaltung-nav">
    <div class="card active" data-target="mitarbeiter-section">
        <h3>Mitarbeiter</h3>
        <p>Mitarbeiter anlegen und verwalten.</p>
    </div>
    <div class="card" data-target="kunden-section">
        <h3>Kunden</h3>
        <p>Kunden anlegen, importieren und verwalten.</p>
    </div>
</div>
<hr>

<!-- Sektionen für die Inhalte -->
<div id="verwaltung-sektionen">

    <!-- Mitarbeiter-Sektion -->
    <div id="mitarbeiter-section" class="config-section active">
        <button class="accordion-button">
            Mitarbeiter hinzufügen
            <span class="add-icon">+</span>
        </button>
        <div class="accordion-content">
            <div class="card">
                <form action="{{ url_for('mitarbeiter_neu') }}" method="post" class="form-inline">
                    <input type="text" name="anrede" placeholder="Anrede" required>
                    <input type="text" name="vorname" placeholder="Vorname" required>
                    <input type="text" name="nachname" placeholder="Nachname" required>
                    <div class="color-palette-container">
                        <div class="color-palette">
                            {% for color in pastel_colors %}
                            <label class="color-swatch-label">
                                <input type="radio" name="farbe" value="{{ color }}" {% if loop.first %}checked{% endif
                                    %}>
                                <span class="color-swatch" style="background-color: {{ color }};"></span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    <button type="submit">Hinzufügen</button>
                </form>
            </div>
        </div>

        <h2>Bestehende Mitarbeiter</h2>
        <!-- KORREKTUR: Dies ist jetzt eine normale Inhalts-Karte, keine Navigations-Kachel -->
        <div class="card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Farbe</th>
                            <th>Vorname</th>
                            <th>Nachname</th>
                            <th>Abteilung</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for m in mitarbeiter %}
                        <tr>
                            <td>
                                <div
                                    style="width: 24px; height: 24px; background-color: {{ m.farbe }}; border: 1px solid var(--border-color); border-radius: 50%;">
                                </div>
                            </td>
                            <td>{{ m.vorname }}</td>
                            <td>{{ m.nachname }}</td>
                            <td>{{ m.abteilung }}</td>
                            <td class="actions">
                                <a href="{{ url_for('mitarbeiter_bearbeiten', id=m.id) }}"
                                    class="button secondary">Bearbeiten</a>
                                <form action="{{ url_for('mitarbeiter_loeschen', id=m.id) }}" method="post"
                                    onsubmit="return confirm('Mitarbeiter wirklich löschen?');">
                                    <button type="submit" class="danger">Löschen</button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5">Noch keine Mitarbeiter angelegt.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Kunden-Sektion -->
    <div id="kunden-section" class="config-section">
        <button class="accordion-button">
            Kunden-Optionen
            <span class="add-icon">+</span>
        </button>
        <div class="accordion-content">
            <div class="card">
                <h4>Neuen Kunden manuell anlegen</h4>
                <form action="{{ url_for('kunde_erstellen') }}" method="post">
                    <fieldset>
                        <legend>Persönliches</legend>
                        <input type="text" name="vorname" placeholder="Vorname">
                        <input type="text" name="nachname" placeholder="Nachname" required>
                    </fieldset>
                    <fieldset>
                        <legend>Zuordnung & Status</legend>
                        <select name="mitarbeiter_id" required>
                            <option value="" disabled selected>Mitarbeiter zuordnen...</option>
                            {% for m in mitarbeiter %}<option value="{{ m.id }}">{{ m.vorname }} {{ m.nachname }}
                            </option>{% endfor %}
                        </select>
                        <select name="status" required>
                            {% for s in status_optionen %}<option value="{{ s }}">{{ s }}</option>{% endfor %}
                        </select>
                    </fieldset>
                    <button type="submit">Kunden erstellen</button>
                </form>
            </div>
            <div class="card">
                <h4>Kunden aus .msg-Dateien importieren</h4>
                <form action="{{ url_for('upload_msg') }}" method="post" enctype="multipart/form-data">
                    <fieldset>
                        <label for="mitarbeiter_id_import">Für welchen Mitarbeiter importieren?</label>
                        <select name="mitarbeiter_id" id="mitarbeiter_id_import" required>
                            <option value="" disabled selected>-- Bitte wählen --</option>
                            {% for m in mitarbeiter %}<option value="{{ m.id }}">{{ m.vorname }} {{ m.nachname }}
                            </option>{% endfor %}
                        </select>
                    </fieldset>
                    <fieldset>
                        <label>Dateien auswählen:</label>
                        <input type="file" name="msg_files" multiple required>
                    </fieldset>
                    <button type="submit">Hochladen & Importieren</button>
                </form>
            </div>
        </div>

        <h2>Bestehende Kunden</h2>
        <!-- KORREKTUR: Dies ist jetzt eine normale Inhalts-Karte, keine Navigations-Kachel -->
        <div class="card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Nachname</th>
                            <th>Vorname</th>
                            <th>Zugeordnet zu</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for k in kunden %}
                        <tr>
                            <td>{{ status_emojis.get(k.status, '') }} {{ k.status }}</td>
                            <td>{{ k.nachname }}</td>
                            <td>{{ k.vorname }}</td>
                            <td
                                style="background-color: {{ k.mitarbeiter.farbe if k.mitarbeiter else 'transparent' }};">
                                {% if k.mitarbeiter %}{{ k.mitarbeiter.nachname }}{% else %}---{% endif %}
                            </td>
                            <td class="actions">
                                <a href="{{ url_for('weihnachtspost_verwalten', kunde_id=k.id) }}"
                                    class="button secondary">Post</a>
                                <a href="{{ url_for('kunde_bearbeiten', id=k.id) }}"
                                    class="button secondary">Bearbeiten</a>
                                <form action="{{ url_for('kunden_loeschen', id=k.id) }}" method="post"
                                    onsubmit="return confirm('Kunde wirklich löschen?');">
                                    <button type="submit" class="danger">Löschen</button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5">Noch keine Kunden angelegt.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        initializeCardNavigation('verwaltung-nav', 'verwaltung-sektionen');
    });
</script>
{% endblock %}
{% extends "base.html" %}
{% from '_macros.html' import render_kontakt_form %}

{% block title %}Verwaltung{% endblock %}

{% block content %}
<h1>Verwaltung</h1>
<p>Wähle einen Bereich aus, um Mitarbeiter oder Kunden zu verwalten.</p>

<div class="card-container" id="verwaltung-nav">
    <div class="card active" data-target="mitarbeiter-section">
        <h3>Mitarbeiter verwalten</h3>
        <p>Mitarbeiter anlegen, bearbeiten und die Übersicht behalten.</p>
    </div>
    <div class="card" data-target="kunden-section">
        <h3>Kunden verwalten</h3>
        <p>Kunden manuell anlegen oder aus Dateien importieren.</p>
    </div>
</div>
<hr>

<div id="verwaltung-sektionen">
    <div id="mitarbeiter-section" class="config-section active">
        <div class="actions-header">
            <h2>Bestehende Mitarbeiter</h2>
            <button id="add-mitarbeiter-btn" class="button">+ Neuen Mitarbeiter anlegen</button>
        </div>
        <div class="card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Farbe</th>
                            <th>Name</th>
                            <th>Position</th>
                            <th>E-Mail</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for m in mitarbeiter %}
                        <tr>
                            <td>
                                <div
                                    style="width: 24px; height: 24px; background-color: {{ m.farbe }}; border: 1px solid var(--border-color); border-radius: 50%;">
                                </div>
                            </td>
                            <td>{{ m.vorname }} {{ m.nachname }}</td>
                            <td>{{ m.position or '---' }}</td>
                            <td>{{ m.email or '---' }}</td>
                            <td class="actions">
                                <a href="{{ url_for('mitarbeiter_bearbeiten', mitarbeiter_id=m.id) }}"
                                    class="button secondary">Bearbeiten</a>
                                <form action="{{ url_for('mitarbeiter_loeschen', id=m.id) }}" method="post"
                                    onsubmit="return confirm('Mitarbeiter wirklich löschen?');"><button type="submit"
                                        class="danger">Löschen</button></form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5">Noch keine Mitarbeiter angelegt.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="kunden-section" class="config-section">
        <div class="actions-header">
            <h2>Bestehende Kunden</h2>
            <div>
                <button id="add-kunde-btn" class="button">+ Neuen Kunden anlegen</button>
                <button id="import-kunde-btn" class="button secondary">↑ Kunden importieren</button>
            </div>
        </div>
        <div class="card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Name</th>
                            <th>Firma</th>
                            <th>Zugeordnet zu</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for k in kunden %}
                        <tr>
                            <td>{{ status_emojis.get(k.status, '') }} {{ k.status }}</td>
                            <td>{{ k.vorname }} {{ k.nachname }}</td>
                            <td>{{ k.firma or '---' }}</td>
                            <td
                                style="background-color: {{ k.mitarbeiter.farbe if k.mitarbeiter else 'transparent' }};">
                                {% if k.mitarbeiter %}{{ k.mitarbeiter.nachname }}{% else %}---{% endif %}
                            </td>
                            <td class="actions">
                                <a href="{{ url_for('benachrichtigung_verwalten', kunde_id=k.id) }}"
                                    class="button secondary">Benachrichtigung</a>
                                <a href="{{ url_for('kunde_bearbeiten', kunde_id=k.id) }}"
                                    class="button secondary">Bearbeiten</a>
                                <form action="{{ url_for('kunden_loeschen', id=k.id) }}" method="post"
                                    onsubmit="return confirm('Kunde wirklich löschen?');"><button type="submit"
                                        class="danger">Löschen</button></form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5">Noch keine Kunden angelegt.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="modal-add-mitarbeiter" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn">&times;</button>
        <h3>Neuen Mitarbeiter hinzufügen</h3>
        {{ render_kontakt_form('Mitarbeiter', {}, url_for('mitarbeiter_neu'), akademische_titel=akademische_titel,
        pastel_colors=pastel_colors) }}
    </div>
</div>

<div id="modal-add-kunde" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn">&times;</button>
        <h3>Neuen Kunden manuell anlegen</h3>
        {{ render_kontakt_form('Kunde', {}, url_for('kunde_erstellen'), mitarbeiter_liste=mitarbeiter,
        status_optionen=status_optionen, status_emojis=status_emojis, akademische_titel=akademische_titel) }}
    </div>
</div>

<div id="modal-import-kunde" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn">&times;</button>
        <h3>Kunden aus .msg-Dateien importieren</h3>
        <form action="{{ url_for('upload_msg') }}" method="post" enctype="multipart/form-data">
            <fieldset>
                <label for="mitarbeiter_id_import">Für welchen Mitarbeiter importieren?</label>
                <select name="mitarbeiter_id" id="mitarbeiter_id_import" required>
                    <option value="" disabled selected>-- Bitte wählen --</option>
                    {% for m in mitarbeiter %}<option value="{{ m.id }}">{{ m.vorname }} {{ m.nachname }}</option>{%
                    endfor %}
                </select>
            </fieldset>
            <fieldset>
                <label>Dateien auswählen:</label>
                <input type="file" name="msg_files" multiple required>
            </fieldset>
            <div class="button-group">
                <button type="submit">Hochladen & Importieren</button>
                <button type="button" class="button secondary modal-cancel-btn">Abbrechen</button>
            </div>
        </form>
    </div>
</div>

<div id="tag-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn">&times;</button>
        <h3>Tags auswählen</h3>
        <div id="modal-tag-list"></div>
        <div class="button-group">
            <button type="button" id="modal-save-btn">Fertig</button>
            <button type="button" class="button secondary modal-cancel-btn">Abbrechen</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/verwaltung.js') }}"></script>
<script src="{{ url_for('static', filename='js/forms.js') }}"></script>
{% endblock %}
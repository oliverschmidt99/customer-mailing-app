<!DOCTYPE html>
{% extends 'base.html' %}
{% block title %}Daten exportieren{% endblock %}

{% block content %}
<h1>Daten exportieren</h1>
<p>
    Hier kannst du Kundendaten in verschiedenen Formaten exportieren. Die Exporte basieren auf den Filtern, die du hier
    einstellst.
</p>

<div class="card config-section active">
    <form method="get" action="{{ url_for('export_page') }}">
        <div class="filter-grid">
            <div class="form-group">
                <label for="mitarbeiter_id">Mitarbeiter</label>
                <select name="mitarbeiter_id" id="mitarbeiter_id">
                    <option value="">Alle Mitarbeiter</option>
                    {% for m in mitarbeiter_liste %}
                    <option value="{{ m.id }}" {% if aktiver_mitarbeiter==m.id|string %}selected{% endif %}>
                        {{ m.vorname }} {{ m.nachname }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="benachrichtigungsart">Benachrichtigungsart (für {{ aktives_jahr }})</label>
                <select name="benachrichtigungsart" id="benachrichtigungsart">
                    <option value="">Alle Arten</option>
                    <option value="brief" {% if aktive_benachrichtigungsart=='brief' %}selected{% endif %}>Brief
                    </option>
                    <option value="kalender" {% if aktive_benachrichtigungsart=='kalender' %}selected{% endif %}>
                        Kalender
                    </option>
                    <option value="email_versand" {% if aktive_benachrichtigungsart=='email_versand' %}selected{% endif
                        %}>E-Mail
                    </option>
                    <option value="speziell" {% if aktive_benachrichtigungsart=='speziell' %}selected{% endif %}>
                        Spezielle Benachrichtigung
                    </option>
                </select>
            </div>
            <div class="form-group">
                <label for="status">Status</label>
                <select name="status" id="status">
                    <option value="">Alle Status</option>
                    {% for s in status_optionen %}
                    <option value="{{ s }}" {% if aktiver_status==s %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" style="align-self: flex-end;">
                <button type="submit" formaction="{{ url_for('export_page') }}" formmethod="get">Filter
                    anwenden</button>
            </div>
        </div>
    </form>
</div>

<div class="card config-section active">
    <h2>Vorschau & Download</h2>
    <p>
        Basierend auf deinen Filtern wurden <strong>{{ kunden|length }}</strong> Kunden gefunden.
    </p>

    <a href="{{ url_for('export_csv', mitarbeiter_id=aktiver_mitarbeiter, status=aktiver_status, benachrichtigungsart=aktive_benachrichtigungsart, jahr=aktives_jahr) }}"
        class="button">
        Als CSV-Datei herunterladen
    </a>

    <hr>

    <h3>Vorschau der ersten 10 Einträge:</h3>
    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
        <table>
            <thead>
                <tr>
                    <th>Nachname</th>
                    <th>Vorname</th>
                    <th>Firma</th>
                    <th>Status</th>
                    <th>Mitarbeiter</th>
                </tr>
            </thead>
            <tbody>
                {% for k in kunden[:10] %}
                <tr>
                    <td>{{ k.nachname }}</td>
                    <td>{{ k.vorname or '---' }}</td>
                    <td>{{ k.firma1 or '---' }}</td>
                    <td>{{ status_emojis.get(k.status, '') }} {{ k.status }}</td>
                    <td style="background-color: {{ k.mitarbeiter.farbe if k.mitarbeiter else '' }};">
                        {% if k.mitarbeiter %}{{ k.mitarbeiter.nachname }}{% else %}---{% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5">Keine Kunden für die aktuellen Filter gefunden.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}